---
title: "Pset 4"
author: "Igor Morzan"
date: "2/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# these are the necessary libraries with their functions for this PSET
library(gt)
library(tidyverse)
library(janitor)
library(lubridate)

data <- read_csv(file = "ps_4_elections-poll-nc09-3.csv",
  col_types = cols(
    .default = col_character(),
    turnout_scale = col_double(),
    turnout_score = col_double(),
    w_LV = col_double(),
    w_RV = col_double(),
    final_weight = col_double(),
    timestamp = col_datetime(format = ""))) %>%
    clean_names() %>%
    filter(!is.na(response), 
         !is.na(race_eth), 
         !is.na(final_weight), 
         educ != "[DO NOT READ] Refused")
```

## Question 1
```{r}
madlib_1 <- data %>% 
  filter(response == "Dem") %>%
  count()
```
There were `r madlib_1` respondents who supported the Democratic candidate.

```{r}
madlib_2_dataframe <- data %>%
  filter(response %in% c("Rep", "Und")) %>%
  group_by(response) %>%
  count()

madlib_2 <- madlib_2_dataframe$n[1] - madlib_2_dataframe$n[2]
```
There were `r madlib_2` more respondents who favored the Republican candidate than who were Undecided.

```{r}
madlib_3 <- data %>%
  select(gender, gender_combined) %>%
  filter(gender != gender_combined) %>%
  count()
```
There are two gender variables (gender and gender_combined). There are `r madlib_3` individuals for whom these variables have different values.

```{r}
madlib_4 <- data %>%
  filter(race_eth == "White") %>%
  filter(file_race_black != "White") %>%
  count()
```
There are `r madlib_4` respondents listed as “White” under race_eth who are not listed as “White” under file_race_black.

```{r}
rep_time <- data %>%
  filter(response == "Rep") %>%
  arrange(timestamp) %>%
  slice(1) %>%
  select(timestamp)

dem_time <- data %>%
  filter(response == "Dem") %>%
  arrange(timestamp) %>%
  slice(1) %>%
  select(timestamp)

madlib_5 <- round(as.numeric(rep_time - dem_time))
```
The first response of Rep came `r madlib_5` minutes (rounded to the nearest minute) before the first response of Dem.

## Question 2
```{r make_chart, echo=FALSE, results="asis"}
# You need results="asis" anytime you want to use gt to create a chart.
table <- data %>% 
  select(response, race_eth, final_weight) %>% 
  mutate(race_eth = fct_relevel(race_eth, c("White", "Black", "Hispanic", "Asian", "Other"))) %>%
  group_by(race_eth, response) %>%
  summarize(total = sum(final_weight)) %>%   
  filter(race_eth != "[DO NOT READ] Don't know/Refused") %>% 
  spread(key =  response, value = total, fill = 0) %>% 
  ungroup() %>%
  mutate(all = Dem + Rep + Und + `3`) %>% 
  mutate(Dem = Dem / all) %>% 
  mutate(Rep = Rep / all) %>% 
  mutate(Und = Und / all) %>% 
  select(-`3`, -all)
  
gt(table) %>% 
  tab_header(title = "Vote Spread by Ethnicity") %>% 
  cols_label(
    race_eth = "",
    Dem = "DEM.",
    Rep = "REP.",
    Und = "UND."
  ) %>%
  fmt_percent(columns = vars(Dem, Rep, Und), decimals = 0) %>% 
  # This little pipe is that incantation to take this pretty table, turn it
  # into html, and send it to the md file we are creating. Future versions of
  # gt will probably have a better way of doing this. Indeed, does anyone know
  # of one?
  na_if(0) %>%
  fmt_missing(columns = vars(Und), rows = 4, missing_text = "---") %>%
    # A title and source label is assigned
  tab_header(title = "Polling Data from 3rd Wave for North Carolina's 9th Congressional District") %>% 
  tab_source_note(source_note = "Source: New York Times Upshot/Siena College 2018 live polls") %>% 
  as_raw_html() %>% 
  as.character() %>% 
  cat()
```

## Question 3
```{r, echo=FALSE}
data %>%
  select(educ, final_weight) %>%
  mutate(educ = fct_relevel(educ, c("Grade school", "High school", "Some college or trade school", 
                                    "Bachelors' degree", "Graduate or Professional Degree"))) %>%
  ggplot(aes(x = educ, y = final_weight)) +
  coord_flip() +
  geom_violin() +
  geom_jitter(alpha = 0.4, width = 0.2, size = 1) +
  labs(title = "More Educated Matter Less in North Carolina 9th",
       subtitle = "Poll gives more weight to people who are less likely to participate in polls",
       caption = "New York Times Upshot/Siena College 2018 live polls") +
  xlab(NULL) +
  ylab("Weight Given to Respondent in Calculating Poll Results")
```

## Question 4
```{r echo=FALSE}
data %>%
  group_by(ager, response) %>%
  filter(ager != "[DO NOT READ] Refused", response != "3") %>%
  summarize(N = n()) %>%
  ggplot(aes(x = ager, y = N, fill = response)) +
  geom_col(position = "dodge2") +
  labs(title = "Political Votes Based on Age", subtitle = "Graph shows voting patterns among age groups",
       caption = "New York Times Upshot/Siena College 2018 live polls") +
  xlab(NULL) + 
  ylab("Percentage of Votes") +
  guides(fill = guide_legend(title = "Response")) +
  coord_flip()
```

## Colleagues
Simone Chu & Margaret Sun
